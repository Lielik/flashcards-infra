---
# Initialize Kubernetes control plane on the first master node

- name: Initialize Kubernetes control plane
  hosts: control_plane[0]
  become: true
  tasks:
    - name: Check if Kubernetes is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_initialized

    - name: Initialize Kubernetes cluster
      shell: |
        kubeadm init \
          --pod-network-cidr=10.244.0.0/16 \
          --apiserver-advertise-address={{ ansible_default_ipv4.address }} \
          --node-name={{ inventory_hostname }}
      when: not k8s_initialized.stat.exists
      register: kubeadm_init

    - name: Display kubeadm init output
      debug:
        var: kubeadm_init.stdout_lines
      when: kubeadm_init.changed

    # ==================== Configure kubectl for root ====================

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: "0755"

    - name: Copy admin.conf to root's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        owner: root
        group: root
        mode: "0600"

    # ==================== Configure kubectl for ubuntu user ====================

    - name: Create .kube directory for ubuntu user
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Copy admin.conf to ubuntu user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu
        group: ubuntu
        mode: "0600"

    # ==================== Install Pod Network (Flannel) ====================

    - name: Check if Flannel is already installed
      shell: kubectl get daemonset -n kube-flannel kube-flannel-ds 2>/dev/null
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_check
      failed_when: false
      changed_when: false

    - name: Download Flannel manifest
      get_url:
        url: https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
        dest: /tmp/kube-flannel.yml
      when: flannel_check.rc != 0

    - name: Apply Flannel CNI
      shell: kubectl apply -f /tmp/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: flannel_check.rc != 0
      register: flannel_apply

    - name: Display Flannel installation message
      debug:
        msg: "{{ 'Flannel CNI installed' if flannel_apply.changed else 'Flannel CNI already installed' }}"

    # ==================== Generate join command ====================

    - name: Check if join command file exists
      stat:
        path: /tmp/kubernetes-join-command.sh
      register: join_command_file

    - name: Generate join command for workers
      shell: kubeadm token create --print-join-command
      register: join_command
      when: not join_command_file.stat.exists or kubeadm_init.changed

    - name: Save join command to file
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/kubernetes-join-command.sh
        mode: "0755"
      when: join_command.changed

    - name: Fetch join command to local machine
      fetch:
        src: /tmp/kubernetes-join-command.sh
        dest: /tmp/kubernetes-join-command.sh
        flat: yes
      when: join_command.changed or not join_command_file.stat.exists

    - name: Display join command status
      debug:
        msg: "{{ 'New join command generated' if join_command.changed else 'Using existing join command' }}"

    # ==================== Wait for cluster to be ready ====================

    - name: Wait for all control plane pods to be ready
      shell: kubectl get pods -n kube-system -o json
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: kube_pods
      until: kube_pods.stdout | from_json | json_query('items[*].status.phase') | unique | list == ["Running"]
      retries: 30
      delay: 10

    - name: Display cluster status
      shell: kubectl get nodes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cluster_status

    - name: Show cluster nodes
      debug:
        var: cluster_status.stdout_lines
