---
# Join worker nodes to the Kubernetes cluster

- name: Join worker nodes to cluster
  hosts: workers
  become: true
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Copy join command from control plane
      copy:
        src: /tmp/kubernetes-join-command.sh
        dest: /tmp/kubernetes-join-command.sh
        mode: "0755"
      when: not kubelet_conf.stat.exists

    - name: Join worker node to cluster
      shell: bash /tmp/kubernetes-join-command.sh
      when: not kubelet_conf.stat.exists
      register: join_result

    - name: Display join result
      debug:
        var: join_result.stdout_lines
      when: join_result.changed

    - name: Wait for kubelet to be ready
      systemd:
        name: kubelet
        state: started
      when: join_result.changed

- name: Verify cluster status
  hosts: control_plane[0]
  become: true
  tasks:
    - name: Wait for all nodes to be ready
      shell: |
        ready_nodes=$(kubectl get nodes --no-headers | grep -c "Ready")
        total_nodes=$(kubectl get nodes --no-headers | wc -l)
        if [ "$ready_nodes" -eq "$total_nodes" ] && [ "$total_nodes" -eq 3 ]; then
          echo "All $total_nodes nodes are Ready"
          exit 0
        else
          echo "Only $ready_nodes/$total_nodes nodes are Ready"
          exit 1
        fi
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: nodes_ready
      until: nodes_ready.rc == 0
      retries: 20
      delay: 10
      changed_when: false

    - name: Display final cluster status
      shell: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: final_status

    - name: Show all nodes
      debug:
        var: final_status.stdout_lines

    - name: Display cluster info
      shell: kubectl cluster-info
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cluster_info

    - name: Show cluster info
      debug:
        var: cluster_info.stdout_lines

    - name: Display success message
      debug:
        msg: |
          Kubernetes cluster installation complete!

          Cluster Summary:
          - Version: v1.34.4
          - Nodes: {{ nodes_ready.stdout }}
          - Control Plane: flashcards-k8s-control-1
          - Workers: flashcards-k8s-worker-1, flashcards-k8s-worker-2

          Next steps:
          1. Copy kubeconfig: scp ubuntu@192.168.0.10:/home/ubuntu/.kube/config ~/.kube/config
          2. Test access: kubectl get nodes
