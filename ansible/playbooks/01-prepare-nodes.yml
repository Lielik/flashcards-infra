---
# Prepares all nodes for Kubernetes installation

- name: Prepare all nodes for Kubernetes
  hosts: all
  # runs as root (sudo) because we modify system configs
  become: true
  tasks:
    # ==================== System Configuration ====================

    - name: Disable swap (required for kubelet)
      shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab

    - name: Load required kernel modules
      copy:
        content: |
          overlay
          br_netfilter
        dest: /etc/modules-load.d/k8s.conf

    - name: Load kernel modules immediately
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Set required sysctl parameters
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        dest: /etc/sysctl.d/k8s.conf

    - name: Apply sysctl parameters
      shell: sysctl --system

    # ==================== Install Containerd ====================

    - name: Install dependencies for containerd
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install containerd
      apt:
        name: containerd.io
        state: present
        update_cache: yes

    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory

    - name: Generate default containerd config
      shell: containerd config default > /etc/containerd/config.toml
      args:
        creates: /etc/containerd/config.toml

    - name: Configure containerd for Kubernetes
      shell: |
        cat <<EOF > /etc/containerd/config.toml
        version = 2
        [plugins]
          [plugins."io.containerd.grpc.v1.cri"]
            [plugins."io.containerd.grpc.v1.cri".containerd]
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
                [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                  runtime_type = "io.containerd.runc.v2"
                  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                    SystemdCgroup = true
        EOF
      notify: restart containerd

    # ==================== Install Kubernetes Packages ====================

    - name: Add Kubernetes GPG key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key
        state: present

    - name: Add Kubernetes repository
      apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /"
        state: present

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet=1.34.4-1.1
          - kubeadm=1.34.4-1.1
          - kubectl=1.34.4-1.1
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages at current version
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    - name: Enable kubelet service
      systemd:
        name: kubelet
        enabled: yes

    # ==================== Install Python Dependencies ====================

    - name: Install pip for Python 3
      apt:
        name: python3-pip
        state: present
        update_cache: yes

    - name: Install Python Kubernetes library (for Ansible k8s module)
      pip:
        name: kubernetes
        state: present
        break_system_packages: yes

    # ==================== Verification ====================

    - name: Verify containerd is running
      systemd:
        name: containerd
        state: started

    - name: Display preparation complete message
      debug:
        msg: "Node {{ inventory_hostname }} is ready for Kubernetes!"

  handlers:
    - name: restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: yes
        daemon_reload: yes
